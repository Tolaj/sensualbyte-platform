version: "3.9"

services:
  api:
    build: ../apps/api
    env_file:
      - ../.env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ../runtime:/app/runtime
      - ../ssh-keys:/app/ssh-keys
    restart: unless-stopped
    networks:
      - sensual_net

  nginx:
    image: nginx:alpine
    depends_on:
      - api
    ports:
      - "8080:80"
    volumes:
      - ./nginx/gateway.conf:/etc/nginx/nginx.conf:ro
      
      # ✅ generated includes
      - ./nginx/sensual-apps.conf:/etc/nginx/conf.d/sensual-apps.conf:ro
      - ./nginx/sensual-apps-servers.conf:/etc/nginx/conf.d/sensual-apps-servers.conf:ro

      # ✅ CRA build output
      - ../apps/dashboard/frontend/build:/usr/share/nginx/html:ro
      
    restart: unless-stopped
    networks:
      - sensual_net

  cloudflared:
    image: cloudflare/cloudflared:latest
    network_mode: host
    volumes:
      - /home/swapnil/.cloudflared:/home/nonroot/.cloudflared
      - ./cloudflared/config.yml:/etc/cloudflared/config.yml:ro
    command: tunnel --config /etc/cloudflared/config.yml run
    restart: unless-stopped

networks:
  sensual_net:
    name: sensual_net
